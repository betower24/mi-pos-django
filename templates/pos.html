{% extends 'base.html' %}
{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <form id="search-form" method="GET" class="input-group">
                    <input type="text" id="codigo_input" name="q" class="form-control" placeholder="Escanear o buscar..." autofocus>
                    <button class="btn btn-secondary" type="button" onclick="iniciarEscaner()"><i class="bi bi-camera"></i></button>
                    <button class="btn btn-primary" type="submit">Buscar</button>
                </form>
                <div id="reader" style="display:none; margin-top:10px;"></div>
            </div>
        </div>

        <div class="row row-cols-2 row-cols-md-4 g-2">
            {% for p in productos %}
            <div class="col">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-2">
                        <small class="d-block text-truncate">{{ p.nombre }}</small>
                        <strong class="text-primary">${{ p.precio }}</strong><br>
                        <small class="text-muted">Stock: {{ p.stock }}</small>
                        <button class="btn btn-sm btn-primary w-100 mt-1" onclick="agregar('{{ p.nombre }}', '{{ p.precio }}', {{ p.stock }})">
                            <i class="bi bi-cart-plus"></i> Agregar
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow-lg">
            <div class="card-header bg-dark text-white text-center">
                <i class="bi bi-receipt"></i> TICKET
            </div>
            <div class="card-body p-0" style="height: 400px; overflow-y: auto;">
                <table class="table table-sm mb-0" id="tabla-ticket">
                    <thead class="table-light">
                        <tr>
                            <th>Producto</th>
                            <th class="text-center" style="width: 120px;">Cantidad</th>
                            <th class="text-end">Subtotal</th>
                            <th style="width: 40px;"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="card-footer bg-light">
                <h3 class="text-center mb-3">Total: <span id="total-text" class="text-success">$0.00</span></h3>
                <button class="btn btn-success btn-lg w-100 mb-2" onclick="finalizarVenta()">
                    <i class="bi bi-cash-coin"></i> COBRAR
                </button>
                <button class="btn btn-link text-danger w-100" onclick="vaciarCarrito()">
                    <i class="bi bi-trash"></i> Vaciar Carrito
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    const KEY = 'pos_tienda_v1';
    let carrito = [];
    let scannerInstance = null;

    function cargarCarrito() {
        try {
            const data = localStorage.getItem(KEY);
            carrito = data ? JSON.parse(data) : [];
        } catch (error) {
            console.error('Error al cargar carrito:', error);
            carrito = [];
        }
    }

    function guardarCarrito() {
        try {
            localStorage.setItem(KEY, JSON.stringify(carrito));
        } catch (error) {
            console.error('Error al guardar carrito:', error);
            alert('No se pudo guardar el carrito. Verifique el espacio disponible.');
        }
    }

    function agregar(nombre, precio, stock) {
        let item = carrito.find(p => p.nombre === nombre);
        
        if (item) {
            if (item.cantidad >= stock) {
                alert(`No hay suficiente stock. Disponible: ${stock}`);
                return;
            }
            item.cantidad++;
        } else {
            if (stock <= 0) {
                alert('Producto sin stock disponible');
                return;
            }
            carrito.push({ nombre: nombre, precio: parseFloat(precio), cantidad: 1, stock: stock });
        }
        actualizar();
    }

    function incrementar(index) {
        const item = carrito[index];
        if (item.cantidad >= item.stock) {
            alert(`Stock máximo alcanzado: ${item.stock}`);
            return;
        }
        item.cantidad++;
        actualizar();
    }

    function decrementar(index) {
        const item = carrito[index];
        if (item.cantidad > 1) {
            item.cantidad--;
            actualizar();
        } else {
            eliminar(index);
        }
    }

    function eliminar(index) {
        if (confirm('¿Eliminar este producto del carrito?')) {
            carrito.splice(index, 1);
            actualizar();
        }
    }

    function vaciarCarrito() {
        if (carrito.length === 0) {
            alert('El carrito ya está vacío');
            return;
        }
        
        if (confirm('¿Seguro que deseas vaciar el carrito?')) {
            carrito = [];
            actualizar();
        }
    }

    function actualizar() {
        guardarCarrito();
        const tabla = document.querySelector('#tabla-ticket tbody');
        let html = '';
        let total = 0;

        if (carrito.length === 0) {
            html = `
                <tr>
                    <td colspan="4" class="text-center text-muted py-4">
                        <i class="bi bi-cart-x" style="font-size: 2rem;"></i>
                        <p class="mb-0 mt-2">Carrito vacío</p>
                    </td>
                </tr>`;
        } else {
            carrito.forEach((p, i) => {
                let sub = p.precio * p.cantidad;
                total += sub;
                html += `
                    <tr>
                        <td>
                            <small class="d-block text-truncate" style="max-width: 100px;" title="${p.nombre}">
                                ${p.nombre}
                            </small>
                            <small class="text-muted">$${p.precio.toFixed(2)} c/u</small>
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-danger" onclick="decrementar(${i})" title="Disminuir">
                                    <i class="bi bi-dash"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" disabled style="min-width: 40px;">
                                    <strong>${p.cantidad}</strong>
                                </button>
                                <button type="button" class="btn btn-outline-success" onclick="incrementar(${i})" title="Aumentar">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                        </td>
                        <td class="text-end">
                            <strong>$${sub.toFixed(2)}</strong>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-link text-danger p-0" onclick="eliminar(${i})" title="Eliminar">
                                <i class="bi bi-x-circle-fill"></i>
                            </button>
                        </td>
                    </tr>`;
            });
        }

        tabla.innerHTML = html;
        document.querySelector('#total-text').innerText = `$${total.toFixed(2)}`;
    }

    async function finalizarVenta() {
        if (carrito.length === 0) {
            alert("El carrito está vacío");
            return;
        }

        const total = carrito.reduce((sum, p) => sum + (p.precio * p.cantidad), 0);

        if (!confirm(`¿Confirmar venta por $${total.toFixed(2)}?`)) {
            return;
        }

        try {
            const response = await fetch("{% url 'procesar_venta' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    carrito: carrito,
                    total: total
                })
            });

            const result = await response.json();

            if (response.ok) {
                alert("¡Venta realizada con éxito!");
                carrito = [];
                try {
                    localStorage.removeItem(KEY);
                } catch (e) {
                    console.error('Error al limpiar localStorage:', e);
                }
                location.reload();
            } else {
                alert("Error: " + (result.message || 'No se pudo procesar la venta'));
            }
        } catch (error) {
            console.error('Error en finalizarVenta:', error);
            alert("Error de conexión con el servidor. Verifique su conexión.");
        }
    }

    function iniciarEscaner() {
        const reader = document.getElementById('reader');
        
        if (scannerInstance) {
            detenerEscaner();
            return;
        }
        
        reader.style.display = 'block';
        
        scannerInstance = new Html5QrcodeScanner(
            "reader", 
            { 
                fps: 10, 
                qrbox: 250,
                aspectRatio: 1.0
            }
        );

        scannerInstance.render(
            (decodedText) => {
                document.getElementById('codigo_input').value = decodedText;
                detenerEscaner();
                document.getElementById('search-form').submit();
            },
            (error) => {}
        );
    }

    function detenerEscaner() {
        if (scannerInstance) {
            scannerInstance.clear().catch(error => {
                console.error('Error al limpiar escáner:', error);
            });
            scannerInstance = null;
            document.getElementById('reader').style.display = 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        cargarCarrito();
        actualizar();
    });

    window.addEventListener('storage', (e) => {
        if (e.key === KEY) {
            cargarCarrito();
            actualizar();
        }
    });
</script>

<style>
    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .table-sm td {
        vertical-align: middle;
    }
    
    #tabla-ticket tbody tr {
        transition: background-color 0.2s ease;
    }
    
    #tabla-ticket tbody tr:hover {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}